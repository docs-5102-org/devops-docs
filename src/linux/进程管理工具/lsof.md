---
title: lsof命令-系统监控
category:
  - Linux
  - 命令帮助
tag:
  - lsof
  - 系统监控
  - 文件管理
  - 网络连接
  - 查看端口
  - port
date: 2022-10-05

---

# lsof命令-系统监控

## 命令简介

lsof（list open files）是一个功能强大的系统监控工具，用于列出当前系统中打开的文件和相关进程信息。在 Linux 系统中，一切都以文件形式存在，包括常规文件、目录、网络连接、硬件设备等，因此 lsof 命令可以帮助系统管理员深入了解系统状态和进程行为。

## 命令格式

```bash
lsof [参数] [文件]
```

## 主要功能

- 查看进程打开的文件
- 查看文件被哪些进程使用
- 查看进程打开的端口（TCP、UDP）
- 监控网络连接状态
- 系统故障排查和性能分析
- 恢复误删除的文件

## 常用参数详解

### 基础参数

| 参数 | 功能描述 |
|------|----------|
| `-a` | 显示与打开文件相关的进程，AND 逻辑连接多个条件 |
| `-c <进程名>` | 显示指定进程名所打开的文件 |
| `-d <文件号>` | 显示占用该文件描述符的进程 |
| `-g <GID>` | 显示指定 GID 进程的详细信息 |
| `-h` | 显示帮助信息 |
| `-i <条件>` | 显示符合条件的网络连接（协议、端口、IP等） |
| `-n` | 不将 IP 转换为主机名，显示数字地址 |
| `-N` | 显示 NFS 文件列表 |
| `-o` | 显示文件偏移量 |
| `-p <进程号>` | 显示指定进程号所打开的文件 |
| `-R` | 显示父进程标识符（PPID） |
| `-u <UID>` | 显示指定 UID 进程的详细信息 |
| `-v` | 显示版本信息 |
| `+d <目录>` | 显示目录下被打开的文件 |
| `+D <目录>` | 递归显示目录下所有被打开的文件 |

### 网络相关参数

| 参数 | 功能描述 |
|------|----------|
| `-i` | 列出所有网络连接 |
| `-i tcp` | 列出所有 TCP 连接 |
| `-i udp` | 列出所有 UDP 连接 |
| `-i :端口号` | 列出使用指定端口的进程 |
| `-i tcp:端口号` | 列出使用指定 TCP 端口的进程 |
| `-i udp:端口号` | 列出使用指定 UDP 端口的进程 |
| `-i @IP地址` | 列出连接到指定 IP 的进程 |

## 输出信息详解

lsof 命令输出包含以下列信息：

### 基本列信息

| 列名 | 说明 |
|------|------|
| **COMMAND** | 进程的名称 |
| **PID** | 进程标识符 |
| **PPID** | 父进程标识符（需要 -R 参数） |
| **USER** | 进程所有者 |
| **FD** | 文件描述符 |
| **TYPE** | 文件类型 |
| **DEVICE** | 设备号 |
| **SIZE/OFF** | 文件大小或偏移量 |
| **NODE** | 索引节点号 |
| **NAME** | 文件的完整路径名 |

### 文件描述符（FD）类型

| 类型 | 说明 |
|------|------|
| **cwd** | 当前工作目录 |
| **txt** | 程序代码文件（二进制文件或共享库） |
| **mem** | 内存映射文件 |
| **rtd** | 根目录 |
| **pd** | 父目录 |
| **0** | 标准输入 |
| **1** | 标准输出 |
| **2** | 标准错误 |
| **数字** | 文件描述符号 |

### 文件状态模式

| 模式 | 说明 |
|------|------|
| **u** | 读写模式 |
| **r** | 只读模式 |
| **w** | 只写模式 |
| **空格** | 状态未知，无锁定 |
| **-** | 状态未知，被锁定 |

### 文件类型（TYPE）

| 类型 | 说明 |
|------|------|
| **DIR** | 目录 |
| **REG** | 普通文件 |
| **CHR** | 字符设备文件 |
| **BLK** | 块设备文件 |
| **UNIX** | Unix 域套接字 |
| **FIFO** | 先进先出队列 |
| **IPv4** | IPv4 网络套接字 |
| **IPv6** | IPv6 网络套接字 |

## 实用示例

### 基础查看操作

#### 1. 查看系统所有打开的文件
```bash
lsof
```

#### 2. 查看特定文件被哪些进程使用
```bash
lsof /bin/bash
lsof /var/log/messages
```

#### 3. 查看目录下的文件使用情况
```bash
# 查看目录下被打开的文件
lsof +d /home/user

# 递归查看目录及子目录
lsof +D /var/log
```

### 进程相关查看

#### 4. 查看指定进程打开的文件
```bash
# 按进程名查看
lsof -c mysql
lsof -c apache
lsof -c sshd

# 按进程ID查看
lsof -p 1234
lsof -p 1,2,3  # 多个进程ID
```

#### 5. 查看用户相关进程
```bash
# 查看指定用户的进程
lsof -u username
lsof -u root

# 排除指定用户
lsof -u ^root
```

### 网络连接查看

#### 6. 查看网络连接
```bash
# 所有网络连接
lsof -i

# TCP连接
lsof -i tcp

# UDP连接
lsof -i udp
```

#### 7. 查看端口使用情况
```bash
# 查看特定端口
lsof -i :80
lsof -i :3306
lsof -i :22

# 查看特定协议端口
lsof -i tcp:80
lsof -i udp:53
```

#### 8. 查看指定IP连接
```bash
lsof -i @192.168.1.100
lsof -i @192.168.1.100:22
```

### 组合查询

#### 9. 复合条件查询
```bash
# 用户与进程组合
lsof -u mysql -c mysqld

# 进程与网络组合
lsof -a -u test -i

# 指定进程的网络连接
lsof -a -p 1234 -i

# 指定命令的文本文件
lsof -c sshd -a -d txt
```

#### 10. 文件描述符查询
```bash
# 查看标准输入输出
lsof -d 0,1,2

# 查看文件描述符范围
lsof -d 2-5

# 查看程序文本文件
lsof -d txt
```

### 实时监控

#### 11. 持续监控
```bash
# 每3秒刷新一次
lsof -i :80 -r 3

# 监控指定主机的多个端口
lsof -i @server.example.com:20,21,22,80 -r 5
```

## 系统管理应用场景

### 1. 故障排查
```bash
# 查找占用端口的进程
lsof -i :8080

# 查看僵尸进程
lsof -p $(ps aux | grep defunct | awk '{print $2}')

# 查看某个文件被哪些进程使用（文件被占用无法删除时）
lsof /path/to/locked/file
```

### 2. 安全审计
```bash
# 查看可疑网络连接
lsof -i | grep ESTABLISHED

# 查看指定用户的网络活动
lsof -a -u suspicious_user -i
```

### 3. 性能监控
```bash
# 查看进程打开的文件数量
lsof -p PID | wc -l

# 监控系统总体文件打开情况
lsof | wc -l
```

### 4. 文件恢复
当文件被误删但进程仍在使用时，可以通过 lsof 找到文件句柄进行恢复：
```bash
# 找到被删除文件的进程
lsof | grep deleted

# 通过 /proc 文件系统恢复
cp /proc/PID/fd/FD /path/to/recover/file
```

## 注意事项

1. **权限要求**：lsof 需要访问内核内存和各种文件，通常需要 root 权限才能获取完整信息
2. **性能影响**：在繁忙的系统上，lsof 可能会产生一定的性能开销
3. **输出过滤**：系统打开的文件数量可能很大，建议结合 grep 等工具进行过滤
4. **版本差异**：不同版本的 lsof 可能在参数和输出格式上有所差异

## 相关命令

- `netstat`：查看网络连接状态
- `ss`：现代的网络统计工具，Socket Statistics
- `fuser`：查看文件或目录的使用进程
- `ps`：查看进程状态
- `pgrep`/`pkill`：按名称查找/终止进程

## 总结

lsof 是 Linux 系统管理中不可或缺的工具，它提供了强大的文件和进程关系查看功能。通过合理使用 lsof 命令，系统管理员可以有效地进行故障排查、性能监控、安全审计等工作。掌握 lsof 的各种参数组合，能够帮助我们更好地理解和管理 Linux 系统。
