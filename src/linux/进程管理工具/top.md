---
title: top命令-系统实时监控
category:
  - Linux
  - 命令帮助
tag:
  - top
  - 系统监控
  - 进程管理
  - 性能分析
date: 2022-10-08

---

# top命令

## 概述

top命令的功能是实时显示系统运行状态，包含处理器、内存、服务、进程等重要资产信息。运维工程师们常常会把top命令比作"加强版的Windows任务管理器"，因为除了能看到常规的服务进程信息之外，还能够对处理器和内存的负载情况一目了然，实时感知系统全局的运行状态。

top命令主要用来监控系统实时负载率、进程的资源占用率及其它各项系统状态属性是否正常。它非常适合作为接手服务器后执行的第一条命令。

## 语法格式

```bash
top [参数] [对象]
```

## 常用参数

| 参数 | 说明 |
|------|------|
| -a | 按内存使用情况排序 |
| -b | 使用批处理模式，不进行交互式显示 |
| -c | 使用显示模式，显示完整的命令行 |
| -d | 设置显示的更新速度（秒） |
| -h | 显示帮助信息 |
| -i | 不显示任何闲置或僵死的行程 |
| -M | 显示内存单位 |
| -n | 设置显示的总次数，完成后自动退出 |
| -p | 仅显示指定进程ID |
| -s | 使用安全模式，不允许交互式指令 |
| -u | 仅显示与指定用户ID |
| -v | 使用线程模式 |
| -w | 设置显示的宽度 |

## 输出界面详解

top命令的输出界面主要分为以下几个部分：

### 1. 系统任务统计信息（第1行）

```
01:06:48 up 1:22, 1 user, load average: 0.06, 0.60, 0.48
```

| 字段 | 说明 |
|------|------|
| 01:06:48 | 当前时间 |
| up 1:22 | 系统运行时间，格式为时:分 |
| 1 user | 当前登录用户数 |
| load average: 0.06, 0.60, 0.48 | 系统负载，即任务队列的平均长度。三个数值分别为1分钟、5分钟、15分钟前到现在的平均值。**注意：**这三个值可以用来判定系统是否负载过高——如果值持续大于系统cpu个数，就需要优化你的程序或者架构了。 |

### 2. 进程和CPU统计信息（第2-6行）

```
Tasks: 29 total, 1 running, 28 sleeping, 0 stopped, 0 zombie
Cpu(s): 0.3%us, 1.0%sy, 0.0%ni, 98.7%id, 0.0%wa, 0.0%hi, 0.0%si
```

| 字段 | 说明 |
|------|------|
| Tasks: 29 total | 进程总数 |
| 1 running | 正在运行的进程数 |
| 28 sleeping | 睡眠的进程数 |
| 0 stopped | 停止的进程数 |
| 0 zombie | 僵尸进程数 |
| Cpu(s): 0.3% us | 用户空间占用CPU百分比 |
| 1.0% sy | 内核空间占用CPU百分比 |
| 0.0% ni | 用户进程空间内改变过优先级的进程占用CPU百分比 |
| 98.7% id | 空闲CPU百分比 |
| 0.0% wa | 等待输入输出的CPU时间百分比 |
| 0.0% hi | Hardware IRQ（硬件中断） |
| 0.0% si | Software IRQ（软件中断） |
| 0.0% st | Steal Time（虚拟化环境中被其他虚拟机占用的CPU时间） |

**注意：**
- IRQ全称为Interrupt Request，即是"中断请求"的意思
- Steal Time只在虚拟化环境中有意义，表示虚拟CPU等待真实CPU的时间百分比

### 3. 内存信息（最后两行）

```
Mem:  191272k total, 173656k used,  17616k free,  22052k buffers
Swap: 192772k total,     0k used, 192772k free, 123988k cached
```

| 字段 | 说明 |
|------|------|
| Mem: 191272k total | 物理内存总量 |
| 173656k used | 使用的物理内存总量 |
| 17616k free | 空闲内存总量 |
| 22052k buffers | 用作内核缓存的内存量 |
| Swap: 192772k total | 交换区总量 |
| 0k used | 使用的交换区总量 |
| 192772k free | 空闲交换区总量 |
| 123988k cached | 缓冲的交换区总量 |

#### 内存计算方式

**实际可用内存计算：**
```
可用内存 = free + (buffers + cached)
```

**程序实际使用内存计算：**
```
已用内存 = used - (buffers + cached)
```

**判断内存不足：**
如果 swap used 数值大于 0，基本可以判断已经遇到内存瓶颈了，要么优化代码，要么加内存。

#### Buffer 与 Cache 的区别

- **Buffer（缓冲）**：用来给块设备做的缓冲大小，主要记录文件系统的metadata以及tracking in-flight pages
- **Cache（缓存）**：用来给文件做缓冲，直接用来记忆我们打开的文件

从应用程序角度来看，buffers/cached 等于可用内存，因为buffer/cached是为了提高文件读写性能，当应用程序需要内存时，buffer/cached会很快被回收。

### 4. 进程信息区

| 列名 | 含义 |
|------|------|
| PID | 进程id |
| PPID | 父进程id |
| RUSER | Real user name |
| UID | 进程所有者的用户id |
| USER | 进程所有者的用户名 |
| GROUP | 进程所有者的组名 |
| TTY | 启动进程的终端名。不是从终端启动的进程则显示为 ? |
| PR | 优先级 |
| NI | nice值。负值表示高优先级，正值表示低优先级 |
| P | 最后使用的CPU，仅在多CPU环境下有意义 |
| %CPU | 上次更新到现在的CPU时间占用百分比 |
| TIME | 进程使用的CPU时间总计，单位秒 |
| TIME+ | 进程使用的CPU时间总计，单位1/100秒 |
| %MEM | 进程使用的物理内存百分比 |
| VIRT | 进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES |
| SWAP | 进程使用的虚拟内存中，被换出的大小，单位kb |
| RES | 进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA |
| CODE | 可执行代码占用的物理内存大小，单位kb |
| DATA | 可执行代码以外的部分(数据段+栈)占用的物理内存大小，单位kb |
| SHR | 共享内存大小，单位kb |
| nFLT | 页面错误次数 |
| nDRT | 最后一次写入到现在，被修改过的页面数 |
| S | 进程状态。D=不可中断的睡眠状态，R=运行，S=睡眠，T=跟踪/停止，Z=僵尸进程 |
| COMMAND | 命令名/命令行 |
| WCHAN | 若该进程在睡眠，则显示睡眠中的系统函数名 |
| Flags | 任务标志，参考 sched.h |

## 交互式命令

在top命令运行过程中，可以使用以下交互式命令：

### 显示控制
- **h 或 ?**：显示帮助画面
- **f**：选择显示的列内容
- **o**：改变列的显示顺序
- **F/O**：按指定列排序进程
- **l**：切换显示平均负载和启动时间信息
- **m**：切换显示内存信息
- **t**：切换显示进程和CPU状态信息
- **c**：切换显示命令名称和完整命令行

### 排序功能
- **P**：根据CPU使用百分比大小进行排序
- **M**：根据驻留内存大小进行排序
- **T**：根据时间/累计时间进行排序
- **R**：将当前的排序倒转

### 进程控制
- **k**：终止一个进程（需要输入PID和信号）
- **r**：重新安排一个进程的优先级别
- **i**：忽略闲置和僵死进程（开关式命令）

### 其他操作
- **s**：改变两次刷新之间的延迟时间
- **S**：切换到累计模式
- **W**：将当前设置写入~/.toprc文件中
- **q**：退出程序
- **Ctrl+L**：擦除并重写屏幕
- **数字1**：显示所有CPU核心的负载情况

## 常用示例

### 基本使用
```bash
# 以默认格式显示系统运行信息
top

# 显示完整的进程路径及名称
top -c

# 以批处理模式显示程序信息
top -b
```

### 高级用法
```bash
# 每隔5秒刷新一次信息
top -d 5

# 显示5次后自动退出
top -n 5

# 监控指定进程
top -p 4360,4358

# 监控指定用户的进程
top -U johndoe    # 按用户名
top -u 500       # 按用户ID

# 显示所有进程信息，适合管道调用
top -bn 1

# 以MB为单位显示内存信息
top -M

# 避免输出控制字符，适合管道调用
top -p 25097 -n 1 -b

# top输出分页显示
top -bn1 | less
```

## 实用技巧

1. **快速排序**：
   - 输入大写P：按CPU占用降序排序
   - 输入大写M：按内存占用降序排序

2. **多核CPU显示**：
   - 按数字1：显示所有CPU核心的负载情况

3. **批处理模式**：
   - 使用 `-b` 参数可以将输出重定向到文件或管道

4. **进程监控**：
   - 可以同时监控多个指定进程：`top -p pid1,pid2,pid3`

5. **配置保存**：
   - 在交互模式下按 `W` 键可以将当前配置保存到 `~/.toprc` 文件

## 增强版替代工具

**htop**：一个更加强大的交互式进程管理器，提供更好的可视化界面和更丰富的功能。

```bash
# 安装htop（CentOS/RHEL）
yum install htop

# 安装htop（Ubuntu/Debian）
apt-get install htop

# 运行htop
htop
```

## 注意事项

1. 在高负载系统上，过于频繁的刷新可能会增加系统负担
2. 使用 `-s` 安全模式可以防止误操作
3. 在虚拟化环境中，要特别关注 `st`（steal time）值
4. 系统负载值持续大于CPU核心数时，需要考虑系统优化
5. 当swap使用量大于0时，通常表示系统内存不足

## 总结

top命令是Linux系统管理中最重要的监控工具之一，通过熟练掌握其各项功能和参数，可以快速诊断系统性能问题，是每个Linux运维人员必须掌握的基础技能。
